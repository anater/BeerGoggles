<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Beer Goggles</title>
	<link rel="stylesheet" href="https://npmcdn.com/tachyons@4.0.1/css/tachyons.min.css">
	<!-- <script src="js/levenshtein.js"></script> -->
    <script src="js/site.js"></script>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <link rel="apple-touch-icon" sizes="180x180" href="img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="img/favicon/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="img/favicon/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="img/favicon/manifest.json">
    <link rel="mask-icon" href="img/favicon/safari-pinned-tab.svg" color="#dbc163">
    <link rel="shortcut icon" href="img/favicon/favicon.ico">
    <meta name="msapplication-config" content="img/favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
</head>
<body>
	<main class="center tc pa3">
        <header id="intro">
    		<h1 class="f1 tracked-tight mt4">Beer Goggles</h1>
            <p class="f4 lh-copy mt5">
                Snap a photo of a beer menu.<br>
                Scan to learn more about the beers.<br>
                Enjoy an informed beer choice.
            </p>
            <p class="f6 lh-copy mt5">
                <span class="db b">For best results:</span>
                Try to fit 10 beers (max) per photo.<br>
                Make sure the menu is well-lit.<br>
                Drink responsibly.
            </p>
    		<label
                class="border-box db relative w-100 mt5 bg-gold pa3 ttu tracked b"
                for="img-to-scan">
    			Scan a menu
                <input
                    id="imgInput"
                    class="absolute absolute--fill o-0"
                    type="file"
                    name="img-to-scan"
                    required>
    		</label>
        </header>
        <section id="preview" class="dn mt5">
            <h2 class="f6 b">Using this menu to find beers:</h2>
            <img
                id="previewImg"
                class="db w-100 mt4"
                src=""
                alt="Your beer menu picture">
        </section>
        <section id="searches" class="dn mt5">
            <h2 id="searchTotal" class="f6 b">5 Searches</h2>
            <ul id="searchList" class="list pa0 mt4">
                <li id="searchItem" class="dn w-100 ba b--black bw1 mb2">
                    <div class="pa3 flex justify-between items-center">
                        <h2 class="searchQuery w-75 ma0 tl f4">Rekorderlig</h2>
                    </div>
                    <ul id="searchResultList" class="list pa0 tl f6">
                        <li id="searchResultItem" class="dn w-100 bt bw1 b--black-10">
                            <div class="pa3 tl">
                                <h4 class="searchResultBeer w-75 ma0 mb1">Rekorderlig Krusbär (Gooseberry)</h4>
                                <span class="searchResultABV b">4.5%</span> |
                                <span class="searchResultStyle">Common Cider</span> |
                                <span class="searchResultBrewery">Åbro Bryggeri</span>
                            </div>
                        </li>
                    </ul>
                </li>
            </ul>
        </section>
        <footer>
            <a
                class="db mt5 gold ttu tracked-mega b f6 lh-copy"
                href="http://andrewnater.com">
                Built by Andrew Nater
            </a>
        </footer>
	</main>
	<script type="text/javascript">
		// grab some DOM
		var imgInput = document.getElementById('imgInput'),
            preview = document.getElementById('preview'),
            previewImg = document.getElementById('previewImg'),
            searches = document.getElementById('searches');

		imgInput.addEventListener('change', handleFileSelect, false);

		function handleFileSelect(e) {
		    for (var i = 0; i < e.target.files.length; i++) {
		        loadFile(e.target.files[i]);
		    }
		}

		function loadFile(file) {
		    var reader = new FileReader();
		    reader.onload = function (e) {
		    	var result = e.target.result,
                    cleanResult = result.replace(/data:image\/jpeg;base64,/, "");

                updatePreviewImg(result);
		    	googleVision(cleanResult.toString(), googleVisionCallback);
		    }
		    reader.readAsDataURL(file);
		}

        function updatePreviewImg(src){
            previewImg.src = src;
            preview.classList.remove('dn');
        }

        function googleVisionCallback(res){
            var wholeText = res.responses[0].textAnnotations[0].description,
                wholeTextByLine = splitByLineBreak(alphaNum(wholeText)),
                finalText = [],
                searchTotal = document.getElementById('searchTotal');

            for(var i = 0; i < wholeTextByLine.length; i++){
                var line = wholeTextByLine[i];
                if(line.length > 3 && line.length < 50){
                    finalText.push(line);
                }
            }
            // run a search for each item in finalText
            for (var i = 0; i < finalText.length; i++) {
                breweryDbSearch(finalText[i], searchCallback);
            }
            // update searchTotal
            searchTotal.textContent = finalText.length + ' ' + (finalText.length === 1 ? 'Search' : 'Searches');
            // reveal searches section
            searches.classList.remove('dn');
        }

        function searchCallback(res, query){
            if(res.status === 'success'){
                buildSearchItem(query, res.data);
            }
            else{
                error.log(res);
            }
        }

        function buildSearchItem(query, results){
            // console.log('buildSearchItem', query);
            var searchItemTemp = document.getElementById('searchItem'),
                search = searchItemTemp.cloneNode(true),
                searchQuery = search.querySelector('.searchQuery')
                searchResultList = search.querySelector('#searchResultList');

            // update text content with arguments
            searchQuery.textContent = query;
            // populate results
            for(var i = 0; i < 3; i++){
                var r = results[i];
                var beer = returnIfAvailable(r.nameDisplay),
                    style = '',
                    abv = returnIfAvailable(r.abv),
                    brewery = returnIfAvailable(r.breweries[0].name);
                if(r.style){
                    style = returnIfAvailable(r.style.shortName);
                }
                var result = buildSearchResultItem(beer, style, abv, brewery);
                // append result to searchResultList
                searchResultList.appendChild(result);
            }
            // remove ids
            search.removeAttribute('id');
            searchResultList.removeAttribute('id');
            // reveal
            search.classList.remove('dn');
            search.classList.add('db');
            // TODO: return item and append where called
            document.getElementById('searchList').appendChild(search);
        }

        function buildSearchResultItem(beer, style, abv, brewery){
            // console.log('buildSearchResultItem', beer);
            var searchResultTemplate = document.querySelector('#searchResultItem'),
                result = searchResultTemplate.cloneNode(true),
                resultBeer = result.querySelector('.searchResultBeer'),
                resultABV = result.querySelector('.searchResultABV'),
                resultStyle = result.querySelector('.searchResultStyle'),
                resultBrewery = result.querySelector('.searchResultBrewery');
            // remove #searchResultItem selector
            result.removeAttribute('id');
            // update text with arguments
            resultBeer.textContent = beer;
            resultABV.textContent = abv + '%';
            resultStyle.textContent = style;
            resultBrewery.textContent = brewery;
            // reveal
            result.classList.remove('dn');
            result.classList.add('db');
            // return new element
            return result;
        }

        function returnIfAvailable(a){
            if(typeof a === 'undefined' || a === null){
                // console.log('Unavailable, sending back a blank string ("")');
                return '';
            }else{
                return a;
            }
        }

        function clearTempElements(){
            document.querySelector('#searchResultItem').remove();
            document.querySelector('#searchItem').remove();
        }
	</script>
</body>
</html>
