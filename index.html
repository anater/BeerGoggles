<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Beer Goggles</title>
	<link rel="stylesheet" href="https://npmcdn.com/tachyons@4.0.1/css/tachyons.min.css">
	<!-- <script src="js/levenshtein.js"></script> -->
    <script src="js/site.js"></script>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <link rel="apple-touch-icon" sizes="180x180" href="img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="img/favicon/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="img/favicon/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="img/favicon/manifest.json">
    <link rel="mask-icon" href="img/favicon/safari-pinned-tab.svg" color="#dbc163">
    <link rel="shortcut icon" href="img/favicon/favicon.ico">
    <meta name="msapplication-config" content="img/favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
</head>
<body>
	<main class="center tc">
        <header id="intro">
    		<h1 class="f1 tracked-tight mt4">Beer Goggles</h1>
            <p class="f4 lh-copy mt5">
                Snap a photo of a beer menu.<br>
                Scan to learn more about the beers.<br>
                Enjoy an informed beer choice.
            </p>
            <p class="f6 lh-copy mt5">
                <span class="db b">For best results:</span>
                Try to fit 10 beers (max) per photo.<br>
                Make sure the menu is well-lit.<br>
                Drink responsibly.
            </p>
    		<label
                class="border-box db relative w-100 mt5 bg-gold pa3 ttu tracked b"
                for="img-to-scan">
    			Scan a menu
                <input
                    id="imgInput"
                    class="absolute absolute--fill o-0"
                    type="file"
                    name="img-to-scan"
                    required>
    		</label>
        </header>
        <section id="preview" class="dn mt5">
            <h2 class="f6 b">Using this menu to find beers:</h2>
            <img
                id="previewImg"
                class="db w-100 mt4"
                src=""
                alt="Your beer menu picture">
        </section>
        <section id="searches" class="dn mt5">
            <h2 id="console" class="f6 b"></h2>
            <ul id="searchList" class="list pa0 mt4"></ul>
        </section>
        <footer>
            <a
                class="db f6 mv4 tracked-mega ttu no-underline black-30"
                href="http://andrewnater.com">
                Built by Andrew Nater
            </a>
        </footer>
	</main>
	<script type="text/javascript">
		// grab some DOM
		var imgInput = document.getElementById('imgInput'),
            preview = document.getElementById('preview'),
            previewImg = document.getElementById('previewImg'),
            searches = document.getElementById('searches'),
            consoleEl = document.getElementById('console');

		imgInput.addEventListener('change', handleFileSelect, false);

		function handleFileSelect(e) {
		    for (var i = 0; i < e.target.files.length; i++) {
		        loadFile(e.target.files[i]);
		    }
		}

		function loadFile(file) {
		    var reader = new FileReader();
		    reader.onload = function (e) {
		    	var result = e.target.result,
                    cleanResult = result.replace(/data:image\/jpeg;base64,/, "");

                updatePreviewImg(result);
                consoleEl.textContent = 'Scanning Menu...';
		    	googleVision(cleanResult.toString(), googleVisionCallback);
		    }
		    reader.readAsDataURL(file);
		}

        function updatePreviewImg(src){
            previewImg.src = src;
            preview.classList.remove('dn');
        }

        function googleVisionCallback(res){
            var wholeText = res.responses[0].textAnnotations[0].description,
                wholeTextByLine = splitByLineBreak(alphaNum(wholeText)),
                finalText = [];
            // update searchTotal
            consoleEl.textContent = 'Searching for beers...';
            for(var i = 0; i < wholeTextByLine.length; i++){
                var line = wholeTextByLine[i];
                if(line.length >= 3 && line.length <= 25){
                    finalText.push(line);
                }
            }
            // run a search for each item in finalText
            for (var i = 0; i < finalText.length; i++) {
            // for (var i = 0; i < 3; i++) { // FOR TESTING
                breweryDbSearch(finalText[i], searchCallback);
                if(i === finalText.length - 1){
                    consoleEl.textContent = finalText.length + ' ' + (finalText.length === 1 ? 'Search' : 'Searches');
                    // consoleEl.textContent = 'Results';
                }
            }
            // reveal searches section
            searches.classList.remove('dn');
        }

        function searchCallback(res, query){
            if(res.status === 'success'){
                // buildSearchItem(query, res.data);
                buildSearch(query, res.data);
            }
            else{
                error.log(res);
            }
        }

        function buildSearch(query, results){
            if(results){
                var search = createEl('li', 'db w-100 mb3 lh-solid'),
                    input = createEl('input', 'pa3 black-30 ma0 b--none w-100 pa0 f3 ttu tracked b'),
                    inputContainer = createEl('div', 'bt bw2 b--black-10'),
                    resultList = createEl('ul', 'list pa0 cf db tl f6');

                input.type = 'search';
                input.placeholder = input.value = query;
                inputContainer.appendChild(input);

                for (var i = 0; i < 3; i++) {
                    if(results && results[i]){
                        var r = results[i],
                            beerName = returnIfAvailable(r.nameDisplay),
                            abv = returnIfAvailable(r.abv),
                            breweryName = returnIfAvailable(r.breweries[0].name),
                            style = '',
                            resultEl;

                        if(r.style){
                            style = returnIfAvailable(r.style.shortName);
                        }

                        resultEl = buildResult(breweryName, beerName, abv, style);

                        if(i === 2){
                            resultEl.classList.add('mb3');
                        }

                        resultList.appendChild(resultEl);
                    }
                    else{
                        console.log('No results for: ' + query);
                    }
                }

                search.appendChild(inputContainer);
                search.appendChild(resultList);
                // append to list
                document.querySelector('#searchList').appendChild(search);
            }
        }

        function buildResult(brewery, beer, abv, style){
            var result = createEl('li', 'db w-100'),
                container = createEl('div', 'pa3'),
                breweryEl = createEl('span', 'db mb2'),
                beerEl = createEl('h4', 'ma0 f4 mb2'),
                abvEl = createEl('span', 'b'),
                styleEl = createEl('span'),
                border = createEl('span', 'bl bw1 pl2 ml2');

            breweryEl.textContent = brewery;
            container.appendChild(breweryEl);

            beerEl.textContent = beer;
            container.appendChild(beerEl);

            if(abv.length > 0){
                abvEl.textContent = abv + '%';
                container.appendChild(abvEl);
            }

            if(abv.length > 0 && style.length > 0){
                container.appendChild(border);
            }

            if(style.length > 0){
                styleEl.textContent = style;
                container.appendChild(styleEl);
            }

            result.appendChild(container);

            return result;
        }

        function createEl(tag, c){
            var el = document.createElement(tag);
            if(c){
                var cSplit = c.split(' ');
                for (var i = 0; i < cSplit.length; i++) {
                    el.classList.add(cSplit[i]);
                }
            }
            return el;
        }

        function returnIfAvailable(a){
            if(typeof a === 'undefined' || a === null){
                // console.log('Unavailable, sending back a blank string ("")');
                return '';
            }else{
                return a;
            }
        }

        function clearTempElements(){
            document.querySelector('#searchResultItem').remove();
            document.querySelector('#searchItem').remove();
        }
	</script>
</body>
</html>
